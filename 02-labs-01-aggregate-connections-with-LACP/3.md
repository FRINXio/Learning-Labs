[lacp-service.py source code]

[>>> Next, head for step 2: Install and configure LACP service application <<<](2.md)  

## Step 2: Provision the LACP service

Now you have application up and running, we can provision the LACP service.

Explore the source code of lacp-service.py through the link on top of the page.

### Configuration process of the XR5 device

Application creates JSON configuration request body for the first node. It configures name, ports and bundle id:

```
    uniconfig_node1 = json_body['node1']
    node1_name = uniconfig_node1['name']
    node1_ports = uniconfig_node1['ports']
    bundle_id = uniconfig_node1['bundle']
    create_bundle(node1_name, bundle_id)
    add_ports_to_bundle(node1_name, bundle_id, node1_ports)
```

The Python code displayed above creates a series of requests, that aims to configure the XR5 device.

**First request creates a bundle which is market as "122"**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr5/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/Bundle-Ether122

```json
{
   "name": "Bundle-Ether122",
   "config": {
       "type": "iana-if-type:ieee8023adLag",
       "enabled": true,
       "name": "Bundle-Ether122"
   }
}
```

**Second request adds interface GigabitEthernet0/0/0/1 to the bundle 122**:


http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr5/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/GigabitEthernet0%2F0%2F0%2F1/frinx-openconfig-if-ethernet:ethernet

```json
{
   "frinx-openconfig-if-ethernet:ethernet": {
       "config": {
           "frinx-openconfig-if-aggregate:aggregate-id": "Bundle-Ether122"
       }
   }
}
```

**Third request adds interface GigabitEthernet0/0/0/3 to the bundle 122**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr5/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/GigabitEthernet0%2F0%2F0%2F3/frinx-openconfig-if-ethernet:ethernet

```json
{
   "frinx-openconfig-if-ethernet:ethernet": {
       "config": {
           "frinx-openconfig-if-aggregate:aggregate-id": "Bundle-Ether122"
       }
   }
}
```

The resulting configuration data on the XR5 device are following.

**Device configuration that creates bundle 122**:

RP/0/0/CPU0:PE1#show run interface Bundle-Ether 122
interface Bundle-Ether122
!

**Device configuration that adds interface GigabitEthernet 0/0/0/1 to the bundle**:

RP/0/0/CPU0:PE1#show run interface GigabitEthernet 0/0/0/1
interface GigabitEthernet0/0/0/1
bundle id 122 mode on
!

**Device configuration that adds interface GigabitEthernet 0/0/0/3 to the bundle**:

RP/0/0/CPU0:PE1#show run interface GigabitEthernet 0/0/0/3
interface GigabitEthernet0/0/0/3
bundle id 122 mode on
!

### Configuration process of the XR6 device

Application creates JSON configuration request body for the node2. It configures name, ports and bundle id:

```
    uniconfig_node2 = json_body['node2']
    node2_name = uniconfig_node2['name']
    node2_ports = uniconfig_node2['ports']
    bundle_id = uniconfig_node2['bundle']
    create_bundle(node2_name, bundle_id)
    add_ports_to_bundle(node2_name, bundle_id, node2_ports)
```

The Python code displayed above creates a series of requests, just like in case of previous configuration of XR5 device. This time, we configure the XR6 device and it's interfaces:

**First request creates a bundle which is market as "187"**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr6/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/Bundle-Ether187

```
{
   "name": "Bundle-Ether187",
   "config": {
       "type": "iana-if-type:ieee8023adLag",
       "enabled": true,
       "name": "Bundle-Ether187"
   }
}
```

**Second request adds interface GigabitEthernet0/0/0/2 to the bundle 187**:


http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr6/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/Bundle-Ether187

```
{
   "name": "Bundle-Ether187",
   "config": {
       "type": "iana-if-type:ieee8023adLag",
       "enabled": true,
       "name": "Bundle-Ether187"
   }
}
```

**Third request adds interface GigabitEthernet0/0/0/3 to the bundle 122**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr6/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/GigabitEthernet0%2F0%2F0%2F5/frinx-openconfig-if-ethernet:ethernet

```
{
   "frinx-openconfig-if-ethernet:ethernet": {
       "config": {
           "frinx-openconfig-if-aggregate:aggregate-id": "Bundle-Ether187"
       }
   }
}
```

The resulting configuration data on the XR6 device are following.

**Device configuration that creates bundle 122**:

RP/0/0/CPU0:PE2#show run interface Bundle-Ether 187
interface Bundle-Ether187
!

**Device configuration that adds interface GigabitEthernet 0/0/0/1 to the bundle**:

RP/0/0/CPU0:PE2#show run interface GigabitEthernet 0/0/0/2
interface GigabitEthernet0/0/0/2
bundle id 187 mode on
!

**Device configuration that adds interface GigabitEthernet 0/0/0/3 to the bundle**:

RP/0/0/CPU0:PE2#show run interface GigabitEthernet 0/0/0/5
interface GigabitEthernet0/0/0/5
bundle id 187 mode on
!

### CalculateDiff and Commit

After creating bundle and configuration data for the XR5 and XR6 devices, we need to commit these changes. Just before that, we should use request called "CalculateDiif", that writes out the list of changes we are about to commit:

POST http://localhost:8181/restconf/operations/uniconfig-manager:calculate-diff

```
{
 "input": {
   "target-nodes": {
              "node": ["xr5", "xr6"]
   }
 }
}
```

The final request that commits all changes:

POST http://localhost:8181/restconf/operations/uniconfig-manager:commit

```
{
 "input": {
   "target-nodes": {
              "node": ["xr5", "xr6"]
   }
 }
}
```

### !!! This is the original form of this slide !!!

Application lacp_service.py exposes really simple and straightforward REST API.
To provision new LACP service, issue simple POST request:

The lacp-service 

```
POST http://127.0.0.1:5000/service/new-service
{
    "node1": {
        "name": "xr5",
        "bundle": "122",
        "ports": [
            "GigabitEthernet0/0/0/1",
            "GigabitEthernet0/0/0/3"
        ]
    },
    "node2": {
        "name": "xr6",
        "bundle": "187",
        "ports": [
            "GigabitEthernet0/0/0/2",
            "GigabitEthernet0/0/0/5"
        ]
    }
}
```

The configuration bundles GigabitEthernet0/0/0/1 and GigabitEthernet0/0/0/3 interfaces into new bundle with id 122 on node1. Similiarly, it bundles GigabitEthernet0/0/0/2 and GigabitEthernet0/0/0/5 into bundle with id 187 on node2.


Application lacp_service.py internally translates this POST request into openconfig uniconfig based configuration, issues several calls to UNICONFIG API and as a result provision the service.
