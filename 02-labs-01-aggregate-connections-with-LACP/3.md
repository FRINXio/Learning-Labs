[lacp-service.py source code]

[>>> Next, head for step 2: Install and configure LACP service application <<<](2.md)  

## Step 2: Provision the LACP service

Now that you have the application up and running, you can provision the LACP service using the service API of our app.

The application lacp_service.py exposes a simple and straightforward REST service API.
To provision a new LACP service on two devices, issue a simple POST request similar to the following:

```
POST http://127.0.0.1:5000/service/new-service
{
    "node1": {
        "name": "xr5",
        "bundle": "122",
        "ports": [
            "GigabitEthernet0/0/0/1",
            "GigabitEthernet0/0/0/3"
        ]
    },
    "node2": {
        "name": "xr6",
        "bundle": "187",
        "ports": [
            "GigabitEthernet0/0/0/2",
            "GigabitEthernet0/0/0/5"
        ]
    }
}
```

The configuration bundles GigabitEthernet0/0/0/1 and GigabitEthernet0/0/0/3 interfaces into a new bundle with id 122 on node1. Similiarly, it bundles GigabitEthernet0/0/0/2 and GigabitEthernet0/0/0/5 into a bundle with id 187 on node2.

The lacp_service.py application translates this POST request internally into OpenConfig based device configuration, issues several calls to the UniConfig API and as a result provision the service on the networking devices. The configurations are applied within a single transaction and should one or both device configuration attempts fail, then UniConfig will revert the configurations back to the state they were in before the configuration attempt started. This helps to keep the network clean and the data consistent.

Explore the source code of lacp-service.py through the link on top of the page.

## Behind the scenes

Following are the steps that happen inside the application to provision the LACP service on both network devices within one transaction. 

### Configuration process of the first device (XR5)

The application creates a JSON configuration request body for the first node. It configures name, ports and bundle id:

```python
    uniconfig_node1 = json_body['node1']
    node1_name = uniconfig_node1['name']
    node1_ports = uniconfig_node1['ports']
    bundle_id = uniconfig_node1['bundle']
    create_bundle(node1_name, bundle_id)
    add_ports_to_bundle(node1_name, bundle_id, node1_ports)
```

**The first request creates a bundle with the id "122"**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr5/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/Bundle-Ether122

```json
{
   "name": "Bundle-Ether122",
   "config": {
       "type": "iana-if-type:ieee8023adLag",
       "enabled": true,
       "name": "Bundle-Ether122"
   }
}
```

**The second request adds interface GigabitEthernet0/0/0/1 to bundle 122**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr5/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/GigabitEthernet0%2F0%2F0%2F1/frinx-openconfig-if-ethernet:ethernet

```json
{
   "frinx-openconfig-if-ethernet:ethernet": {
       "config": {
           "frinx-openconfig-if-aggregate:aggregate-id": "Bundle-Ether122"
       }
   }
}
```

**The third request adds interface GigabitEthernet0/0/0/3 to the bundle 122**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr5/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/GigabitEthernet0%2F0%2F0%2F3/frinx-openconfig-if-ethernet:ethernet

```json
{
   "frinx-openconfig-if-ethernet:ethernet": {
       "config": {
           "frinx-openconfig-if-aggregate:aggregate-id": "Bundle-Ether122"
       }
   }
}
```

### Configuration process of the XR6 device

Application creates JSON configuration request body for the node2. It configures name, ports and bundle id:

```
    uniconfig_node2 = json_body['node2']
    node2_name = uniconfig_node2['name']
    node2_ports = uniconfig_node2['ports']
    bundle_id = uniconfig_node2['bundle']
    create_bundle(node2_name, bundle_id)
    add_ports_to_bundle(node2_name, bundle_id, node2_ports)
```

The Python code displayed above creates a series of requests, just like in case of previous configuration of XR5 device. This time, we configure the XR6 device and it's interfaces:

**First request creates a bundle which is market as "187"**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr6/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/Bundle-Ether187

```
{
   "name": "Bundle-Ether187",
   "config": {
       "type": "iana-if-type:ieee8023adLag",
       "enabled": true,
       "name": "Bundle-Ether187"
   }
}
```

**Second request adds interface GigabitEthernet0/0/0/2 to the bundle 187**:


http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr6/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/Bundle-Ether187

```
{
   "name": "Bundle-Ether187",
   "config": {
       "type": "iana-if-type:ieee8023adLag",
       "enabled": true,
       "name": "Bundle-Ether187"
   }
}
```

**Third request adds interface GigabitEthernet0/0/0/3 to the bundle 122**:

http://localhost:8181/restconf/config/network-topology:network-topology/topology/uniconfig/node/xr6/frinx-uniconfig-topology:configuration/frinx-openconfig-interfaces:interfaces/interface/GigabitEthernet0%2F0%2F0%2F5/frinx-openconfig-if-ethernet:ethernet

```
{
   "frinx-openconfig-if-ethernet:ethernet": {
       "config": {
           "frinx-openconfig-if-aggregate:aggregate-id": "Bundle-Ether187"
       }
   }
}
```

### CalculateDiff and Commit

After creating bundle and configuration data for the XR5 and XR6 devices, we need to commit these changes. Just before that, we can use the request called "CalculateDiff", that writes out the list of changes we are about to commit:

POST http://localhost:8181/restconf/operations/uniconfig-manager:calculate-diff

```
{
 "input": {
   "target-nodes": {
              "node": ["xr5", "xr6"]
   }
 }
}
```

The final request that commits all changes and configures the devices:

POST http://localhost:8181/restconf/operations/uniconfig-manager:commit

```
{
 "input": {
   "target-nodes": {
              "node": ["xr5", "xr6"]
   }
 }
}
```

## Configuration data

The resulting configuration snippets on the XR devices are shown below.

**Resulting configuration on the first device**:

RP/0/0/CPU0:PE1#show run interface Bundle-Ether 122
interface Bundle-Ether122
!
RP/0/0/CPU0:PE1#show run interface GigabitEthernet 0/0/0/1
interface GigabitEthernet0/0/0/1
bundle id 122 mode on
!
RP/0/0/CPU0:PE1#show run interface GigabitEthernet 0/0/0/3
interface GigabitEthernet0/0/0/3
bundle id 122 mode on
!

**Resulting configuration on the second device**:

RP/0/0/CPU0:PE2#show run interface Bundle-Ether 187
interface Bundle-Ether187
!
RP/0/0/CPU0:PE2#show run interface GigabitEthernet 0/0/0/2
interface GigabitEthernet0/0/0/2
bundle id 187 mode on
!
RP/0/0/CPU0:PE2#show run interface GigabitEthernet 0/0/0/5
interface GigabitEthernet0/0/0/5
bundle id 187 mode on
!



